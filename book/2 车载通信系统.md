**2 车载通信系统**

**2.1 简介**

如图2.1所示，模块化设计架构中的一个关键部件是车载通信网络，它网络允许电子控制单元（ECUs）、传感器和其他部件相互通信。其中，由于其简单的通信逻辑，控制器局域网络（CAN）总线已经成为目前应用最为广泛的车载通信网络。

在本章中，我们将介绍车载通信系统。首先，我们将会介绍CAN总线，它一般作为一种高集成度的串行总线系统被广泛用于智能设备互联。此外，我们还介绍了FlexRay，这是一种与汽车制造商和主要供应商联合开发确定的，且具有容错性和高速性的总线系统；FlexRay总线旨在逐步取代CAN，成为默认的车载通信网络。最后，我们会介绍CANopen，这是一种用于自动化领域的嵌入式系统通信协议和设备配置文件规范。并针对CANopen，向读者讲述CANopenNode，这是一种以ANSIC编写且面向对象编程的免费开源的CANopen栈。我们相信，本章节会为读者了解车载通信网络提供足够的背景知识。

![图片](Aspose.Words.a469d1d5-e056-421f-875c-2e6cd7c64f7b.001.png)

图 2.1 模块化设计架构

在上面的 2.1 图中，最下方分别为底盘(Chassis)，声呐(Sonars)，毫米波雷达(Radar)；通过中间的控制器区域网络(CAN bus)将底层传感器与上面的规划控制(Planning and Control)联系在一起，然后规划控制与计算机视觉(Computer Vision)、地图(Map)和全球定位系统(GNSS)关联在一起。

**2.2 控制器局域网络（CAN）**

CAN总线是一种高完整性的串行总线系统，常用于智能设备之间的组网。在现代自动驾驶车辆和工业系统中，CAN总线设备是常用的部件。通过对带有CAN接口的设备进行开发，可以实现与其他CAN接口设备进行网络通信的应用程序[1,2]。

在过去的几十年里，由于汽车技术的进步，现在越来越多的汽车使用了电子控制系统来实现发动机正时（指的是在发动机的压缩冲程终了,活塞达到行程的顶点时,点火系统向火花塞提供高压火花以点燃气缸内的压缩混合气做功,这个时间就是发动机正时）、防抱死制动系统和无分电器式电子点火等功能。最初，点对点式的布线系统被用于连接车辆中的电子设备。但随着车辆电子设备数量的增加，点对点式的布线系统会导致车辆中的线束重量过大、成本过高，并且不具备可扩展性。

为了取代传统的点对点布线，汽车制造商开始使用车载网络，车载网络有效地降低了车辆的布线成本、复杂性和重量。在1985年，博世(Bosch)在原有的车载网络的基础上开发了CAN总线网络，目前CAN已经成为现代标准的车载网络。

CAN总线网络为现代汽车提供了一种廉价且耐用的通信网络，通过ECUs可以方便地实现设备之间的通信。相较于模拟输入将信号传递到系统的每个设备中，CAN总线允许每一个ECUs拥有一个CAN接口，这大大降低了汽车的整体制造成本和重量。网络中的所有设备都会配备一个CAN控制器芯片，因此这些设备都可以被CAN总线智能控制。在CAN总线网络上，所有传输的信息都可以被该网络上的所有设备看到，同时每个设备也可以自主决定消息是否对其有价值，以便过滤掉不必要的信息。

随着CAN总线在汽车行业广泛应用，这类高速传输的网络被国际标准化为ISO 11898标准。随后，低速通信的CAN也被引入到汽车领域中，成为车身电子装置相互通信的协议。而更先进的单线CAN也被应用到一些和车身舒适性相关的设备通信中。此外，英特尔、摩托罗拉、飞利浦等主要半导体制造商也相应的为汽车开发了定制的CAN通信芯片。到20世纪90年代中期，CAN已经成为许多工业设备网络协议的基础，包括DeviceNet和CANOpen等应用层协议在标准的CAN总线上运行。

如图2.2所示，下图展示了CAN规定的媒体访问控制（MAC）和物理层信令（PLS），并将它们应用于OSI模型的第1层和第2层。 MAC作为一种媒体访问控制机制，主要是通过一种称为非破坏性逐位仲裁的技术来实现的。当站点将其独特的标识符应用于网络时，它们会观察到其数据是否被准确地输出。

![图片](Aspose.Words.a469d1d5-e056-421f-875c-2e6cd7c64f7b.002.png)

图2.2  CAN的协议层

在上面2.2图中得，应用层（Application Layer)从下到上被分为为ISO媒体（第0层）（ISO Media /Layer 0)包括传输介质（Transmission Media）；ISO物理层（第一层）（ISO Physical /Layer 1)包括物理层信令（Physical Layer Signaling/PLS) ,中型连接装置（Medium Attachment Unit /MAU) ;ISO数据链（第2层）(ISO Data Link/Layer 2)包括逻辑链路控制（Logical Link Control /LLC) ,媒体访问控制(Media Access Control /MAC)。其中媒体访问控制（Media Access Control /MAC）和物理层信令（Physical Layer Signaling/PLS) 组成了CAN协议层。


如果数据未能准确地输出，那么该站点将会认为有更高优先级的信息正在被发送，因此会停止自身数据的发送并恢复到接收模式，以便让最高优先级的信息先通过，而较低优先级的信息则会在另一个时间重新发送。 这种方法的优点是网络上的冲突不会破坏数据，并且最终所有站点都可以访问网络。 但是，这种方法的问题在于仲裁是在逐个比特位的基础上进行的，这就要求所有站点在一个比特时间内（实际上应该小于一个比特时间）互相监听。

通常情况下，当CAN在500kbps的通信率下，一个比特位的通信时间只允许在2000纳秒内，这就要求CAN总线的收发器和网线具有较小的时间延迟。因此，CAN网络之间的距离通常比较短，在需要高速CAN网络通信的情况下其距离通常小于100米。如果需要增加传输距离，则可以采用降低CAN总线的数据速率或使用额外的设备提供转接支持的方法。

CAN总线通常使用"生产者-消费者"模型来完成信号的传输，这保证了信息的点对点传输，即一段数据通过CAN总线设备进行传输时，不会寻址到其他设备上。反过来，消息数据的内容由标识符字段指定的，这就要求标识符字段在网络中必须是唯一的。它除了会提供信息传递的内容外，还会指定该消息数据的优先级。这样的机制确保了所有设备都可以在保证数据不冲突的前提下监听发送端的数据，并有选择性的接收感兴趣的信息。

CAN总线的数据过滤是通过一个接受滤波器来实现的，这种滤波器是CAN控制器芯片中的一个组成部分。该滤波器在工作时会制订一个数据接收的标准，而未能通过数据接收标准的消息将被设备拒绝。因此，接收设备只接受来自生产者(数据发送端)感兴趣的信息。如图2.3所示，一个CAN帧由标识字段、控制字段和数据字段组成。从CAN的消息的格式来看，控制字段长度为6个字节，数据字段长度在0-8字节之间，标识字段长度在不同规范中不同，例如在标准帧（CAN规范2.0A）中，标识字段长度为11字节，在扩展帧（CAN规范2.0B）中，标识字段长度为29字节。当使用CAN数据链路层协议时，源节点和目的节点（数据发送的起始点地址和目标点地址）都没有意义，不会起作用。

CAN总线使用无损位仲裁（即非破坏性仲裁）的方案来完成仲裁，其目的是允许多个发送器同时向总线发送数据，所谓的“无损”就是指在发送数据的时候存在优先级高低之分，优先级最高的可以直接发送，优先级低的就会自动退回，等待空闲时重新向总线发送数据，所以对于优先级最高的节点来说“发送时间”就是无损的。使用“Wired-AND”机制时，显性状态（逻辑0）将会覆盖隐性状态（逻辑1）。当各个发送器在总线上发送数据时，它们同时会逐位监测其数据的实时传输情况，直到发现某个发送器的显性状态位覆盖了其隐性状态位。这意味着存在一个具有更高优先级信息的设备，还有一个具有较低二进制值的标识符的设备存在，仲裁失败者（指优先级较低的信息设备）会立即恢复到接收信息模式继续完成信息的接收。采用这种方法的优势就是没有数据被破坏，因此，数据传输的量和效率都得到了提高。仲裁失败者只是在下一次机会中再试一次。但这个方案的问题是，所有设备必须在同一比特时间内和采样点之前判断并确定其数据，否则数据将被错误地接收甚至破坏。因此，我们需要考虑影响布线距离的时间限制问题。

![图片](Aspose.Words.a469d1d5-e056-421f-875c-2e6cd7c64f7b.003.png)

图2.3  CAN消息格式。

从上面2.3图中可以看到，一个CAN消息当中有以下几个部分组成，从左到右有：帧起始(SOF，标志着数据帧和远程帧的起始)，仲裁字段（Arbitration Field）,远程发送请求位（RTR，RTR位在数据帧里必须为“显性”，而在远程帧里必须为“隐性”。它是区别数据帧和远程帧的标志），识别符扩展位（IDE），控制字段（Control Field），数据长度代码（DLC，用于规定数据段的字节数），数据字段（Data Field），CRC段（CRC Field，该段用于检查帧传输错误，又称循环冗余校验）,	确认字符(ACK,用来确认是否正常接收)，帧结束（End of Frame）,其中在Data Field这些部分是由比特（bit，表示信息的最小的单位），字节（ Byte，是计算机信息技术用于计量存储容量的一种计量单位）组成的。

**2.3 FlexRay总线**

FlexRay总线是一种用于汽车的高速的，具备可确定性和故障容错能力的总线技术，由汽车制造商和领先的设备供应商共同开发[3]。FlexRay为线控驱动的应用提供了较高的容错性和时间确定性，从而满足线控驱动自身的性能要求。FlexRay总线具有网络利用率高和系统灵活的特点。这种技术可以满足可以满足传统CAN方案不能满足的汽车线控系统（X-by-Wire）的要求。

FlexRay总线的许多设计都是为了降低成本，但同时又能满足设备在较为恶劣的环境中提供完美的表现。FlexRay总线是通过非屏蔽双绞线（UTP，是一种数据传输线，由四对不同颜色的传输线互相缠绕所组成）将节点连接在一起的。FlexRay总线在设计中支持单通道和双通道两种线路配置，分别是由一对或两对导线组成的。这种线路配置的优势就是，外部噪声对每对线上的差分信号的影响减少了（是用一个数值来表示两个物理量之间的差异，从严格意义上来讲，所有电压信号都是差分的，而一个电压只能是相对于另一个电压而言的），从而不需要太昂贵的屏蔽设置，就可以达到降低成本的目的。目前大多数FlexRay总线的节点通常也设置有电源线和地线为收发器和微处理器供电。双通道配置的主要作用是提供了较强的容错能力并增加了带宽（总线带宽指的是总线在单位时间内可以传输的数据总量，等于总线位宽与工作频率的乘积）。

目前大多数第一代的FlexRay总线的网络都只使用一个通道来降低布线的成本，但随着应用程序逐渐变得复杂，和对安全性的要求越来越高，未来的网络将会更倾向于采用双信号通道的线路配置。FlexRay总线要求信号线两端接电阻，并仅在多分支总线上的末端节点处需要有载（即连接电阻），末端接线太多或太少都会破坏FlexRay网络。尽管特定的网络实现有所不同，但典型的FlexRay网络的电缆阻抗在80到110欧姆之间，并且末端节点会以阻抗作为终端连接处。将FlexRay节点连接到测试装置时，终端电阻是造成网络通讯失败的最常见原因之一。现代基于PC的FlexRay接口可能包含用于简化布线的板载终端电阻

**2.3.1 FlexRay 拓扑结构（Topology）**

与CAN总线不同的是，FlexRay总线支持多种类型的拓扑结构，主要包含有以下几种连接方式：例如简单的多点无源连接、用于更复杂网络的有源星形连接和混合型网络。根据车辆的布局和FlexRay的使用水平来选择正确的拓扑结构，可以帮助设计者在成本、性能和可靠性方面进行优化

**（1）多点总线（Multi-drop Bus）：**

具体来说，FlexRay 通常用于简单的多点总线拓扑结构，即通过一根网线将多个ECU（电子控制单元）连接在一起运行。这种拓扑结构和CAN的拓扑结构类似，也是OEM（原始设备制造商）所熟悉的，因此多点总线（Multi-drop Bus）结构是第一代FlexRay车辆中最受欢迎的拓扑结构。 在这种拓扑结构中，每个ECU可以从核心的 "主干 "上引出一小段"分支"。同时，在网络的两端会安装负载电阻，以消除信号反射的问题。FlexRay的工作频率很高，最高可达10Mbps(1Mbit/s = 0.125Mbps)，比CAN通常的1Mbit工作频率相比高出许多，因此FlexRay的设计者必须注意选择正确的端接电阻和网络布局，以避免信号完整性的问题。这种多点格式也非常适合于具有相似布局类型的车辆线束，从而简化了安装，减少了整个车辆布线的难度。

**（2）星型网络（Star network）：**

FlexRay标准还支持 "星型 "网络的配置，该配置由连接到中央活动节点的各个链路构成。这个节点在功能上类似于PC以太网中的集线器。该主动星型网络的配置使得FlexRay网络可以在更远的距离上运行；这种星型网络的形式还起到了分割网络的作用， 如果网络的某一部分发生故障，星型网络的设计使故障区域不会影响其他部分网络的正常运行，从而使整个FlexRay星型网络更加可靠。同样的，如果说星形网络的一个分支被切断或短路，其他的支路也仍可以继续运行。同时，长距离的电线往往会传导更多的环境噪声，例如大型电动机的电磁辐射，而FlexRay星型网络使用多条分支的结构也可以减少裸线电缆的数量，进而有助于提高整个FlexRay通信的抗噪能力。

**（3）混合型网络（Hybrid network）：**

最后要讲的是混合型网络，它将多点总线型和星型拓扑结构结合起来，形成一种混合拓扑结构。未来的FlexRay网络很有可能是由混合网络构成，因为混合网络可以充分利用多点总线型拓扑结构的易用性和成本优势，同时在车辆需要高性能和可靠性的地方应用星型网络，从而为车辆提供更好的性能和可靠性。

**2.3.2 FlexRay通信协议（Communication Protocol）**

FlexRay通信协议是一种独特的时间触发协议，它提供了两种方式处理数据，一种是处理确定性数据，即在可确定的时间范围内（精确到微秒）到达的确定性数据，另一种是处理动态事件驱动数据，类似于CAN，可以处理不同类型的帧以处理大量的数据。FlexRay通过一个预先设定的通信周期完成了这种核心静态帧和动态帧的混合，并为在通信周期内的静态和动态数据提供了一个预定义的空间。该空间由网络设计者完成配置，他们根据网络需求分配总线周期。

CAN总线和FlexRay网络都是用于车辆通信的总线技术。与CAN总线相比，FlexRay网络需要节点了解网络的配置才能进行通信，而CAN总线只需要知道正确的波特率（表示单位时间内传送的码元符号的个数，它是对符号传输速率的一种度量）即可。另外，与其他的多点总线通信一样，FlexRay通信也是一次只有一个节点可以将数据写入总线。如果两个节点同时写入，那么就会导致两个节点对总线通信资源发生争抢，并且会导致传输数据的损坏。目前，有多种方案可以解决争用总线通信资源这一问题。例如，CAN采用了一种仲裁方案，在该方案中，如果节点看到总线上发送的消息具有更高优先级，则它们会让位于其他节点，从而保证数据传输的正确性。虽然这种技术灵活且易于扩展，但它不能支持很高的数据速率，也不能保证数据的及时传递。

FlexRay通常使用时分多址（	Time division multiple access，缩写TDMA，是一种为实现共享传输介质或者网络的通信技术）方案来管理总线上的多个节点。这使得每个FlexRay节点都与同一时钟同步，并且每个节点都等待其在总线上写入的时机。 因为在TDMA方案中时序是一致的，所以FlexRay能够保证数据自身的确定性以及数据传递到网络节点的一致性。这为非常依赖节点传输数据确定性以及一致性的系统提供了许多优势。总的来说，嵌入式网络与PC网络的不同之处在于，嵌入式网络具有封闭的配置，即在产品组装后就不会再更改。 这消除了客户在使用该嵌入式网络时需要发现并配置设备的需求。

网络设计师可以通过提前完成对网络的配置来节省大量的配置成本，并提高网络的可靠性。对于像FlexRay这样的TDMA网络来说，要想使其正常工作，就必须正确地配置所有节点。FlexRay标准可以适用于许多不同类型的网络，并允许网络设计师在网络更新速度、确定性、数据量、动态数据量以及其他参数之间进行权衡。每个FlexRay网络都可能不同，因此必须在每个节点都使用正确的网络参数编程之后，才能应用在总线上。

表2.1提供了一个CAN和FlexRay之间的比较表格[4]。在本章的其余部分，我们将继续重点介绍CAN，因为它仍然是当今最流行的协议，并且使用起来也很便捷。

` `表2.1 CAN和FlexRay之间的比较。

||CAN|FlexRay|
| - | - | - |
|频数（Bandwidth）|1 Mbps|10 Mbps|
|通道数（Number of channels)|1|<p>2</p><p></p>|
|帧数据长度（Frame data of length）|0~8|0~254|
|通信方式（Communication）|动态仲裁（Dynamic arbitration)|时间分址（Time division multiple access 的缩写TDMA)|
|复杂度（Complexity）|低|高|
|可组合性(Composability)|不可组合|可组合|
|灵活性（Flexibility)|单拓扑结构（One topology)|多种类型拓扑结构(Many different topologies)|

**2.4 CANopen**

CANopen协议是一种通信协议和设备配置文件规范，通常用于自动化领域的嵌入式系统中的。就OSI模型而言（如图2.1所示），CANopen实现了网络层即以上的协议。CANopen标准由寻址方案、多个小型的通信子协议和设备描述文件定义的应用层组成[5]。

CANopen通信协议支持网络管理（NMT）、设备监控和节点间的通信，其中包括一个简易的传输层，可以处理资料的分段传输及其组合。一般而言，数据链路层和物理层的底层协议使用CAN实现的，除CANopen以外，还有其他一些协议（如以太网Powerlink、Ether CAT等）也可以实现CANopen的设备配置文件。

CANopen 的基本设备和通讯配置文件在由CiA（CAN in Automation）发布的CiA 301规范中给出。还有许多专业设备的子协定也是建立在这个基本通讯配置文件之上的，并在CAN in Automation中发布的其他标准中有指定，例如用于I/O模块的CiA 401和用于运动控制的CiA 402。

每个使用CANopen的设备都必须在其控制软件中实现某些特定的标准功能。在此基础上，通信单元可以实现与网络中的其他节点进行消息传递的协议。除此之外，设备的启动和复位（设备重置）是通过一个状态机（	是协调相关信号动作、完成特定操作的控制中心）控制的。这个过程必须包含初始化、预操作、操作和停止这四个状态。

在CANopen通信协议中，状态之间的转换是通过向设备发出一段NMT通信对象来实现的。这里就需要引入对象字典的概念。对象字典（  Object Dictionary，缩写OD，是CANopen协议最为核心的概念，就是一个有序的对象组）是一个索引为16位的变量数组，每个变量还设定了一个8位的子索引值，从而能更方便地访问数据结构中的元素。这些变量对于配置设备并反映其环境状态，如包含测量数据等，具有重要作用。将状态机设置为操作状态后，设备的应用程序部分执行设备所需的功能。其中，应用程序是通过对象字典中的变量进行配置的，数据的发送和接收是通过通信层完成的。

**2.4.1 对象字典（Object Dictionary）**

每个CANopen设备都必须支持一个对象字典，该字典用于配置设备并与设备进行通信。对象字典中的对象（entry）一般为:

● 索引，在字典中，对应对象的16位地址

● 对象名称（对象的类型/大小），描述条目中对象的符号类型，例如数组、记录或简单变量

●名称，一段描述条目的字符串

●类型，它给出变量的数据类型(或数组中所有变量的数据类型)

●属性，它提供了该条目的访问权限信息，可以是读/写、只读或只读

●强制性/选择性字段(M/O)，定义了该符合规范的设备是否必须实现该对象字段

对象字典值的基本数据由多种类型的数据组成，一般有布尔值、整数和浮点数等，这些数据在标准中都有定义(它们的字节大小可以选性地存储在相关定义的类型中，索引范围为0x0001-0x001F)，还有复合数据类型，如字符串、数组和记录（定义的索引范围为0x0040-0x025F）。复合数据类型还可以用一个8位索引进行子索引；数组或记录的子索引0中的值来表示某个数据结构中的元素数量，这种数据类型被称为UNSIGNED8型。

**2.4.2  配置文件族（Profile Family）**

CANopen给基于CAN的分布式自动化工业系统定义了一个标准化的应用。在这个应用中，CANopen的配置文件族都是基于 "通信配置文件"的标准，它规定了基本的通信机制和描述设备功能的标准化形式。

数字信号和模拟信号I/O模块、驱动器、操作设备、传感器或可编程控制器等都是自动驾驶领域中最重要的设备类型，这些设备都遵循所谓的 "设备配置文件 "标准进行描述。设备配置文件规定了相应类型标准的设备的功能、参数和数据等信息。当前的趋势是，所有设备的配置文件都是基于标准化的配置文件，不同制造商的设备可以使用完全相同的方式进行总线访问。因此，不同制造商的设备是可以互相操作的和互相交换的。

CANopen标准的关键部分是通过 "对象字典"（OD）来描述设备的功能。一般来说，对象字典分为两个部分。第一部分包含一般的设备信息，如设备标识、制造商名称等，以及通信参数。第二部分描述具体的设备功能。简单来说，就是通过一个16位的索引和一个8位的子索引来确定对象字典中的一个条目（"对象"）。对象字典中的条目提供对设备 "应用对象 "的标准化访问，例如输入和输出信号、设备参数、设备功能或网络变量等。

通常情况下，可以使用ASCII格式的 "电子数据表"（EDS）来描述CANopen设备的功能和特性。EDS可以被视为一种模板，其主要工作是用来描述设备的所有数据和特性，通常可以通过网络访问。实际设备的设置是通过 "设备构造文件"（DCF）来描述的。EDS和DCF都能以数据文件的形式提供，它可以从互联网上直接下载或存储在设备内。

**2.4.3  数据传输和网络管理（Data Transmission and Network Management）**

与其他现场总线系统（	是一种连接智能现场设备和自动化系统的全数字、 双向 、多站的通信系统 ）类似，CANopen也区分了两种基本的数据传输机制：一种是通过 “服务数据对象”（SDO）访问对象字典的条目，另一种是通过 “过程数据对象”（PDO）交换过程数据。PDO根据生产者-消费者原则，并以广播消息的形式进行传输，可以由事件触发，循环传输，或由节点请求触发，并且不需要任何额外的协议开销（协议本身的IP报文头等内容，需要占用掉一定的长度，用以标识该种协议、报文内各个字段的含义等信息）。简言之，PDO是一种单向传输，不需要接收节点回应报文进行确认。但是一个PDO的传输数据最大长度只能为8个字节，在传输数据大小上还是一定限制。

当该同步消息（"同步PDO"）与其他同步PDO链接的时候，PDO的传输和接收可以在整个网络中同步。应用对象到PDO数据字段的映射，可以通过一个被称为 “PDO映射”的数据结构进行配置，该结构被存储在对象字典中。通过该结构，可以根据应用的特定要求来对设备进行动态配置。

通过SDO通道传输数据是在两个节点之间以客户端-服务器的方式进行的。通过提供条目的索引和子索引来完成对象字典条目的寻址。该机制在传输的信息量上较有优势，传输的信息可以有非常大的长度。但是，如果传输的SDO消息超过8个字节，就会涉及到额外的分段协议开销。“紧急信息”是一种高优先级的标准化事件，用于报告设备故障。此时，可以通过系统时间消息提供一个共同的系统时间，以便记录故障的相关信息。

目前，网络管理（NMT）的功能，如控制和监测总线上节点的通信状态，主要由NMT设施完成。这是根据逻辑上的主-从关系配置的。这两个用于节点监控的机制（"节点保护 "和 "心跳消息（	Heartbeat Message，是一种发送源发送到接收方的消息，这种消息可以让接收方确定发送源是否以及何时出现故障或终止）"）通常被交替着使用。分配CAN消息的方式可以通过直接修改对象字典数据结构中的标识符来完成，以将CAN消息标识符分配给PDO和SDO。对于简单的系统结构，可以直接使用预定义的标识符来达到相同的目的。此外，除了设备配置文件，还有一些特定的兴趣小组开发的各种特定的应用程序的配置文件可供使用。各种制造商通过基于CANopen的设备、配置和测试的工具以及经过认证的CANopen协议栈（又称协议堆叠，是计算机网络协议套件的一个具体的软件实现）来支持CANopen运行。

**2.4.4  通信模型（Communication Models）**

CAN总线作为CANopen的数据链路层，只能传输一个由11位标识符、远程传输请求位（RTR）和0-8个字节的数据组成的短包数据。根据CANopen的标准，11位CAN帧标识符被分为4位功能码和7位CANopen节点ID。这个规定将CANopen网络中的设备数量限制在127个（0通常被保留用于广播）。虽然CAN总线标准（CAN 2.0 B）的扩展允许29位扩展帧标识符，但在实践中，CANopen网络传输数据一般都比较小，而大到需要使用扩展标识符范围的情况很少见。在CANopen中，一个CAN帧的11位标识符被称为通信对象标识符或COB-ID。当发生传输冲突时，CAN总线会启用总线仲裁机制，该仲裁机制允许具有最小标识符的帧优先传输，并且没有延迟。所以在实际使用时，一般使用较低的代码号来实现校对时间等关键功能，从而可以尽可能地降低延迟并保持稳定。

在CANopen节点之间的消息传递中使用了不同类型的通信模型。在主从关系中，一个CANopen节点被指定为主节点，它可以向从节点发送或请求数据。NMT协议是一个主从通信模型的典型例子。客户端-服务器关系在SDO协议中得到实现，其中SDO客户端将数据（对象字典索引和子索引）发送到SDO服务器，SDO服务器通过一个或多个包含所请求数据的SDO包进行回复（给定索引处对象字典的内容），数据包包含请求数据（给定索引处对象字典的内容）。生产者-消费者模型被用于心跳（Heartbeat）和节点守护（Node Guarding）协议中。在生产者-消费者的推送模式（信息推送模式是由信源主动将信息推送给用户的一种方式，如电台广播）中，生产者向消费者发送数据而无需特定的请求，而是在拉动模式中，消费者必须向生产者请求数据。

**2.4.5 CANopen节点（CANopenNode）**

CANopenNode是一款免费且开源的CANopen Stack，它使用面向对象的ANSI C语言编写而成[6]。CANopen Stack可以在不同的微控制器上作为一个独立的应用程序运行，也可以在实时操作系统上运行。CANopenNode堆栈包括主节点功能。

CANopenNode实现了以下CANopen的功能：

`     `● NMT从节点可以启动，停止，和重置设备；简单的NMT主节点。

`     `●	心跳协议（Heartbeat protocol）是用来监控生产者-消费者网络中的节点及确认其是否正常工作。

`     `●过程数据对象 (PDO) 协议用于连接和动态映射，可在许多节点之间快速交换过程变量。

`     `●服务数据对象(SDO)可用来存取远端节点的对象字典，读取或设定其中的数据。SDO也支援长数据包的分割（segmentation）和合并（desegmentation）。SDO能够快速访问所有参数的加急传输、分段传输和块传输。

`     `●SDO主节点。

`     `●有紧急情况会发出消息。

`     `●同步生产者-消费者的数据。

`     `●非易失性存储（存储器所存储的信息在电源关掉之后依然能长时间存在，不易丢失）

但是，CANopenNode本身不具备任何微控制器的完整可工作代码。它只是一个库，包含不同微控制器的堆栈和驱动程序。CANopenNode包含示例代码，这些代码在任何带有模板驱动程序的系统上都可以进行编译，但实际上，模板驱动程序它并不是访问CAN的硬件，而应是CANopenNode作为一个Git子模块（Git子模块指向子存储库上的特定提交），包含在一个具有特定硬件和特定应用程序的项目中。

![图片](Aspose.Words.a469d1d5-e056-421f-875c-2e6cd7c64f7b.004.png)

`  `图2.4  一个典型的CANopenNode实现的流程图

从上面2.4图中可看到，从上到下：程序启动(Program start)，CANopen初始化（CANopen init），启动线程（Start threads）包括三大部分，第一部分CAN接收线程（CAN receive thread）包含---快速响应（Fast response）---检测CAN标识(Detect CAN ID)-部分处理消息并将数据复制到目标CANopen对象（Partially process message and copy data to target CANopen objects）；第二部分定时器间隔线程（Timer interval thread）包含---具有恒定间隔的实时线程，通常为1 ms(Real-time thread with constant interval,typically 1ms)---网络同步(Network synchronized)---复制输入 (RP DO，硬件)到对象字典(Copy inputs(RPD0s,HW) to object dictionary)---可能会调用申请进行一些处理(Many call application for some processing)---将变量从对象字典复制到输出(TPDOs，HW)(Copy variables from object dictionary to outputs(TPDOs，HW))；第三部分主干线程（Mainline thread）包含---在CANopen对象中处理耗时任务（Processing of time-consuming tasks in CANopen objects）:SD0服务器(SDO server)，紧急情况（Emergency），网络状态（Network state），心跳（Heartbeat）。还有可循环调用应用程序代码（May cyclically call application code）。

下面深蓝色表格为，SDO客户端（可选）（ SDO client（optional）)，可以被外部应用程序调用 （Can be called by external application），可以从CANopen网络中的任何节点读取或写入对象字典的任何变量（Can read or write any node in the CANopen network）。

图2.4显示了一个典型的CANopenNode实现的流程图：当程序启动时，它调用CANopen init，并产生了多个线程。CAN接收线程监听任何CAN消息，并通过处理消息和复制数据到目标CANopen对象来提供快速响应。定时器间隔线程是一个实时线程，它每隔一毫秒就被唤醒一次，来处理对象字典的输入和输出。主线程通过调用相应的应用程序代码来处理耗时任务。

**参考文献**

**1** National Instruments (2017). Controller Area Network (CAN) Tutorial. <http://download.> ni.com/pub/devzone/tut/can\_tutorial.pdf (accessed 1October 2018). 

**2** Contemporary Controls (2017). CAN Tutorial. <https://www.ccontrols.com/pdf/CANtutorial.> pdf (accessed 1 October 2018). 

**3** National Instruments (2017). FlexRay Automotive Communication Bus Overview.  <http://www.ni.com/white>‐paper/3352/en (accessed 1 October 2018). 

**4** Forsberg, A. and Hedberg, J. (2012). Comparison of FlexRay and CAN‐bus for real‐time  communication. *IEEE Transactions on Industrial Electronics* 58 (3). 

**5** CAN in Automation (2017). CANopen. <https://www.can>‐cia.org/canopen (accessed  1 October 2019). 

**6** GitHub (2019). CANopenNode. <https://github.com/CANopenNode/CANopenNode>  (accessed 1 October 2019).

